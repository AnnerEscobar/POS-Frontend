<div class="h-full flex flex-col">
  <!-- Header acciones -->
  <div class="flex flex-wrap items-center gap-3 pb-3">
    <h1 class="text-2xl md:text-3xl font-semibold text-gray-800 mr-auto">Nueva venta</h1>

    <!-- Sin "Abrir caja" -->
    <button mat-stroked-button color="primary" class="rounded-xl px-4" (click)="startFreeSale()">Nueva venta
      libre</button>

    <button mat-stroked-button class="rounded-xl px-4 bg-rose-500 text-white border-rose-500 hover:bg-rose-600"
      (click)="newExpense()">Nuevo gasto</button>
  </div>

  <mat-divider></mat-divider>

  <!-- Buscador -->
  <div class="flex flex-wrap items-center gap-3 py-3">
    <mat-form-field appearance="outline" class="flex-1 min-w-[240px]">
      <mat-label>Buscar productos</mat-label>
      <input matInput [formControl]="form.controls.search" (input)="applySearch()">
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>
  </div>

  <!-- CategorÃ­as -->
  <div class="flex flex-wrap gap-2 mb-3">
    <button mat-stroked-button class="rounded-full px-3 py-1"
      [color]="selectedCategory() === null ? 'primary' : undefined" (click)="selectCategory(null)">Todos</button>

    <button mat-stroked-button class="rounded-full px-3 py-1" *ngFor="let c of categories()"
      [color]="selectedCategory() === c ? 'primary' : undefined" (click)="selectCategory(c)">{{ c }}</button>
  </div>

  <!-- Main: grid 1fr + columna derecha fija en desktop -->
  <div class="grid gap-4 h-[calc(100vh-260px)] grid-cols-1 lg:grid-cols-[1fr_380px]">
    <!-- Izquierda: grid de productos -->
    <div class="overflow-auto pr-1">
      <div class="grid grid-cols-2 sm:grid-cols-3 2xl:grid-cols-4 gap-4">

        <!-- Card Crear producto (mismo tamaÃ±o que las demÃ¡s) -->
        <mat-card class="rounded-2xl shadow-sm hover:shadow-md transition cursor-pointer h-56"
          (click)="createProduct()">
          <div class="p-3 h-full flex flex-col">
            <div class="flex-1 rounded-xl border-2 border-dashed border-gray-300 grid place-items-center">
              <div class="text-center">
                <div class="rounded-full border border-gray-400 w-10 h-10 grid place-items-center mx-auto mb-2">
                  <mat-icon>add</mat-icon>
                </div>
                <div class="text-gray-700 font-medium">Crear producto</div>
              </div>
            </div>
          </div>
        </mat-card>

        <!-- Cards de producto -->
        <mat-card *ngFor="let p of filteredProducts()"
          class="relative rounded-2xl shadow-sm hover:shadow-md transition cursor-pointer h-56" (click)="addToCart(p)">
          <div class="p-3 h-full flex flex-col">
            <div class="h-28 rounded-xl bg-gray-100 grid place-items-center mb-3">
              <mat-icon class="text-4xl text-gray-400">inventory_2</mat-icon>
            </div>
            <div class="text-sm text-gray-500">Q {{ p.price | number:'1.0-0' }}</div>
            <div class="font-medium text-gray-800 truncate">{{ p.name }}</div>
            <div *ngIf="p.stock !== undefined" class="mt-2">
              <span class="inline-block text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">
                {{ p.stock }} disponibles
              </span>
            </div>

            <!-- badge con cantidad en canasta -->
            <span *ngIf="countInCart(p.id) > 0"
              class="absolute top-2 right-2 inline-flex items-center justify-center w-6 h-6 text-xs font-semibold rounded-full bg-slate-800 text-white">
              {{ countInCart(p.id) }}
            </span>
          </div>
        </mat-card>
      </div>
    </div>

    <!-- DERECHA: CARRITO con estilo mÃ³vil -->
<div class="relative bg-white border border-gray-200 rounded-2xl h-full overflow-hidden flex flex-col">
  <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
    <h2 class="text-base font-semibold text-gray-800">Productos</h2>
    <button mat-button class="text-sm" (click)="clearCart()" [disabled]="cart().length===0">
      Vaciar canasta
    </button>
  </div>

  <!-- LISTA -->
  <div class="flex-1 overflow-auto px-4 pb-28"> <!-- pb para que no tape el botÃ³n -->
    <ng-container *ngIf="cart().length > 0; else emptyCart">
      <div *ngFor="let it of cart(); trackBy: trackById" class="py-4">
        <!-- Encabezado del Ã­tem -->
        <div class="flex items-start justify-between gap-3">
          <div class="flex items-center gap-3 min-w-0">
            <img [src]="it.image || ''" alt="" class="w-10 h-10 rounded-md bg-gray-100 object-cover" />
            <div class="min-w-0">
              <div class="text-sm font-semibold text-gray-800 truncate">{{ it.name }}</div>
              <div class="text-xs text-gray-500">{{ (it.stock ?? 0) }} Disponibles</div>
            </div>
          </div>

          <!-- Eliminar (borde rojo) -->
          <button mat-icon-button (click)="remove(it)"
                  class="border border-rose-300 text-rose-600 rounded-full">
            <mat-icon color="warn">delete</mat-icon>
          </button>
        </div>

        <!-- Controles cantidad + precio -->
        <div class="mt-3 flex items-center gap-3">
          <!-- PÃ­ldora âˆ’ qty + -->
          <div class="flex items-center rounded-full border border-gray-300 h-12 px-2">
            <button mat-icon-button class="!w-9 !h-9" (click)="dec(it)">
              <mat-icon >remove</mat-icon>
            </button>
            <span class="w-8 text-center font-medium">{{ it.qty }}</span>
            <button mat-icon-button class="!w-9 !h-9" (click)="inc(it)">
              <mat-icon >add</mat-icon>
            </button>
          </div>

          <!-- Precio unitario (solo lectura) -->
          <mat-form-field appearance="outline" class="flex-1">
            <input matInput [value]="'Q ' + (it.price | number:'1.2-2')" readonly />
          </mat-form-field>
        </div>

        <!-- Subtotal + divisor -->
        <div class="mt-3 text-sm font-semibold text-gray-700">
          Precio por {{ it.qty }} unidades: Q {{ (it.qty * it.price) | number:'1.2-2' }}
        </div>

        <mat-divider class="mt-4"></mat-divider>
      </div>
    </ng-container>
  </div>

  <ng-template #emptyCart>
    <div class="h-full px-6 py-12 text-center flex flex-col items-center justify-center gap-2">
      <div class="text-6xl">ðŸ›’</div>
      <p class="text-gray-600">AÃºn no tienes productos en la canasta.</p>
    </div>
  </ng-template>

  <!-- BOTÃ“N CONTINUAR: dentro del carrito, por encima del FAB -->
  <div class="absolute left-4 right-4 bottom-14 z-[70]">
    <button
      mat-flat-button color="primary"
      class="w-full rounded-full h-12 shadow-md flex items-center justify-between px-3"
      [disabled]="cart().length===0"
      (click)="continue()"
    >
      <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-slate-200 text-slate-800 mr-2">
        {{ totalItems() }}
      </span>
      <span class="font-medium">Continuar</span>
      <span class="ml-auto mr-1">Q {{ totalAmount() | number:'1.2-2' }}</span>
      <mat-icon>chevron_right</mat-icon>
    </button>
  </div>
</div>



