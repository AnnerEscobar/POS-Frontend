<div class="h-full flex flex-col">
  <!-- Header acciones -->
  <div class="flex flex-wrap items-center gap-3 pb-3">
    <h1 class="text-2xl md:text-3xl font-semibold text-gray-800 mr-auto">
      Nueva venta
    </h1>

    <!-- Sin "Abrir caja" -->
    <button mat-stroked-button color="primary" class="rounded-xl px-4" (click)="startFreeSale()">
      Nueva venta libre
    </button>

    <button mat-stroked-button class="rounded-xl px-4 bg-rose-500 text-white border-rose-500 hover:bg-rose-600"
      (click)="newExpense()">
      Nuevo gasto
    </button>
  </div>

  <mat-divider></mat-divider>

  <!-- Buscador -->
  <div class="flex flex-wrap items-center gap-3 py-3">
    <mat-form-field appearance="outline" class="flex-1 min-w-[240px]">
      <mat-label>Buscar productos</mat-label>
      <input matInput [formControl]="form.controls.search" (input)="onSearchChange($any($event.target).value)"
        (keyup.enter)="onContinue()" />
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>
  </div>

  <!-- CategorÃ­as -->
  <div class="flex flex-wrap gap-2 mb-3">
    <!-- botÃ³n "Todos" -->
    <button mat-stroked-button class="rounded-full px-3 py-1"
      [color]="selectedCategory === null ? 'primary' : undefined" (click)="selectCategory(null)">
      Todos
    </button>

    <!-- chips de categorÃ­as -->
    <button mat-stroked-button class="rounded-full px-3 py-1" *ngFor="let c of categories()"
      [color]="selectedCategory === c ? 'primary' : undefined" (click)="selectCategory(c)">
      {{ c }}
    </button>

  </div>

  <!-- Main: grid 1fr + columna derecha fija en desktop -->
  <div class="grid gap-4 h-[calc(100vh-260px)] grid-cols-1 lg:grid-cols-[1fr_380px]">

    <!-- Izquierda: grid de productos -->
    <div class="overflow-auto pr-1">
      <div class="grid grid-cols-2 sm:grid-cols-3 2xl:grid-cols-4 gap-4">

        <!-- Card Crear producto -->
        <mat-card class="rounded-2xl shadow-sm hover:shadow-md transition cursor-pointer h-56"
          (click)="createProduct()">
          <div class="p-3 h-full flex flex-col">
            <div class="flex-1 rounded-xl border-2 border-dashed border-gray-300 grid place-items-center">
              <div class="text-center">
                <div class="rounded-full border border-gray-400 w-10 h-10 grid place-items-center mx-auto mb-2">
                  <mat-icon>add</mat-icon>
                </div>
                <div class="text-gray-700 font-medium">Crear producto</div>
              </div>
            </div>
          </div>
        </mat-card>

        <!-- Cards de producto -->
        <mat-card *ngFor="let p of filteredProducts"
          class="relative rounded-2xl shadow-sm hover:shadow-md transition cursor-pointer h-56" (click)="addToCart(p)">
          <div class="p-3 h-full flex flex-col">
            <div class="h-28 rounded-xl bg-gray-100 grid place-items-center mb-3">
              <mat-icon class="text-4xl text-gray-400">inventory_2</mat-icon>
            </div>
            <div class="text-sm text-gray-500">
              Q {{ p.price | number:'1.0-0' }}
            </div>
            <div class="font-medium text-gray-800 truncate">
              {{ p.name }}
            </div>
            <div *ngIf="p.stock !== undefined" class="mt-2">
              <span class="inline-block text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">
                {{ p.stock }} disponibles
              </span>
            </div>

            <!-- badge con cantidad en canasta -->
            <span *ngIf="countInCart(p.id) > 0"
              class="absolute top-2 right-2 inline-flex items-center justify-center w-6 h-6 text-xs font-semibold rounded-full bg-slate-800 text-white">
              {{ countInCart(p.id) }}
            </span>
          </div>
        </mat-card>
      </div>
    </div>

    <!-- DERECHA: PANEL (carrito o pago) -->
    <div class="relative bg-white border border-gray-200 rounded-2xl h-full overflow-hidden flex flex-col">

      <!-- MODO CARRITO -->
      <ng-container *ngIf="!paymentMode; else paymentPanel">

        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
          <h2 class="text-base font-semibold text-gray-800">Productos</h2>
          <button mat-button class="text-sm" (click)="clearCart()" [disabled]="cart.length===0">
            Vaciar canasta
          </button>
        </div>

        <div class="flex-1 overflow-auto px-4 pb-28">
          <ng-container *ngIf="cart.length > 0; else emptyCart">
            <div *ngFor="let it of cart" class="py-4">
              <!-- Encabezado del Ã­tem -->
              <div class="flex items-start justify-between gap-3">
                <div class="flex items-center gap-3 min-w-0">
                  <img [src]="it.image || ''" alt="" class="w-10 h-10 rounded-md bg-gray-100 object-cover" />
                  <div class="min-w-0">
                    <div class="text-sm font-semibold text-gray-800 truncate">{{ it.name }}</div>
                    <div class="text-xs text-gray-500">{{ (it.stock ?? 0) }} Disponibles</div>
                  </div>
                </div>

                <button mat-icon-button (click)="removeFromCart(it)"
                  class="border border-rose-300 text-rose-600 rounded-full">
                  <mat-icon color="warn">delete</mat-icon>
                </button>
              </div>

              <!-- Controles cantidad + precio -->
              <div class="mt-3 flex items-center gap-3">
                <div class="flex items-center rounded-full border border-gray-300 h-12 px-2">
                  <button mat-icon-button class="!w-9 !h-9" (click)="decreaseQuantity(it)">
                    <mat-icon>remove</mat-icon>
                  </button>
                  <span class="w-8 text-center font-medium">{{ it.quantity }}</span>
                  <button mat-icon-button class="!w-9 !h-9" (click)="increaseQuantity(it)">
                    <mat-icon>add</mat-icon>
                  </button>
                </div>

                <mat-form-field appearance="outline" class="flex-1">
                  <input matInput [value]="'Q ' + (it.price | number:'1.2-2')" readonly />
                </mat-form-field>
              </div>

              <div class="mt-3 text-sm font-semibold text-gray-700">
                Precio por {{ it.quantity }} unidades: Q {{ (it.quantity * it.price) | number:'1.2-2' }}
              </div>

              <mat-divider class="mt-4"></mat-divider>
            </div>
          </ng-container>
        </div>

        <ng-template #emptyCart>
          <div class="h-full px-6 py-12 text-center flex flex-col items-center justify-center gap-2">
            <div class="text-6xl">ðŸ›’</div>
            <p class="text-gray-600">AÃºn no tienes productos en la canasta.</p>
          </div>
        </ng-template>

        <!-- BOTÃ“N CONTINUAR -->
        <div class="absolute left-4 right-4 bottom-4 z-[70]">
          <button mat-flat-button color="primary"
            class="w-full rounded-full h-12 shadow-md flex items-center justify-between px-3"
            [disabled]="cart.length===0" (click)="onContinue()">
            <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-slate-200 text-slate-800 mr-2">
              {{ cart.length }}
            </span>
            <span class="font-medium">Continuar</span>
            <span class="ml-auto mr-1">Q {{ cartTotal | number:'1.2-2' }}</span>
            <mat-icon>chevron_right</mat-icon>
          </button>
        </div>

      </ng-container>

      <!-- MODO PAGO -->
      <!-- MODO PAGO -->
      <ng-template #paymentPanel>
        <div class="flex flex-col h-full">

          <!-- Header -->
          <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 bg-slate-50">
            <div class="flex items-center gap-2">
              <button mat-icon-button (click)="cancelPayment()">
                <mat-icon>arrow_back</mat-icon>
              </button>
              <div>
                <h2 class="text-base font-semibold text-gray-800">Pago</h2>
                <p class="text-xs text-gray-500">Confirma los datos antes de crear la venta</p>
              </div>
            </div>
            <div class="text-sm text-gray-600 text-right">
              Total
              <div class="text-lg font-semibold text-slate-900">
                Q {{ cartTotal | number:'1.2-2' }}
              </div>
            </div>
          </div>

          <!-- Contenido -->
          <div class="flex-1 overflow-auto px-4 pb-24 pt-3">
            <form [formGroup]="paymentForm" class="space-y-4" (ngSubmit)="confirmPayment()">

              <!-- Cliente -->
              <div class="rounded-2xl border border-slate-200 p-4 space-y-3">
                <h3 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
                  <mat-icon class="text-sm">person</mat-icon>
                  Cliente
                </h3>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Nombre del cliente</mat-label>
                  <input matInput formControlName="customerName" placeholder="Opcional">
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>NIT</mat-label>
                  <input matInput formControlName="customerNit">
                </mat-form-field>
              </div>

              <!-- MÃ©todo de pago -->
              <div class="rounded-2xl border border-slate-200 p-4 space-y-3">
                <h3 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
                  <mat-icon class="text-sm">payments</mat-icon>
                  MÃ©todo de pago
                </h3>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>MÃ©todo de pago</mat-label>
                  <mat-select formControlName="method" (selectionChange)="updateChange()">
                    <mat-option value="efectivo">Efectivo</mat-option>
                    <mat-option value="tarjeta">Tarjeta</mat-option>
                    <mat-option value="transferencia">Transferencia</mat-option>
                    <mat-option value="mixto">Mixto</mat-option>
                  </mat-select>
                </mat-form-field>


                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <mat-form-field appearance="outline" class="w-full">
                    <mat-label>Monto recibido</mat-label>
                    <input matInput type="number" formControlName="paid" #paidInput (input)="updateChange()">
                  </mat-form-field>


                  <mat-form-field appearance="outline" class="w-full">
                    <mat-label>Cambio</mat-label>
                    <input matInput formControlName="change" readonly>
                  </mat-form-field>
                </div>
              </div>

              <!-- Resumen -->
              <div class="rounded-2xl border border-emerald-200 bg-emerald-50 p-4 flex items-center justify-between">
                <div>
                  <p class="text-xs uppercase tracking-wide text-emerald-700">Total a cobrar</p>
                  <p class="text-xl font-semibold text-emerald-900">
                    Q {{ cartTotal | number:'1.2-2' }}
                  </p>
                </div>
                <div class="text-right text-xs text-emerald-700">
                  {{ cart.length }} producto(s) <br />
                  MÃ©todo: {{ paymentForm.value.method || 'efectivo' }}
                </div>
              </div>

              <!-- BotÃ³n inferior -->
              <div class="absolute left-4 right-4 bottom-4 z-[70]">
                <button mat-flat-button color="primary"
                  class="w-full rounded-full h-12 shadow-md flex items-center justify-between px-3" type="submit">
                  <span
                    class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-slate-200 text-slate-800 mr-2">
                    {{ cart.length }}
                  </span>
                  <span class="font-medium">Crear venta</span>
                  <span class="ml-auto mr-1">Q {{ cartTotal | number:'1.2-2' }}</span>
                  <mat-icon>check</mat-icon>
                </button>

              </div>

            </form>
          </div>



        </div>
      </ng-template>

    </div>

  </div>
</div>
