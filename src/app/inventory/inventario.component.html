<section class="h-full flex flex-col min-h-0">
  <!-- HEADER SUPERIOR (FIJO) -->
  <div class="flex items-start justify-between gap-3 pb-3">
    <div>
      <h1 class="text-2xl md:text-3xl font-semibold text-gray-800">Inventario</h1>
      <div class="mt-2 flex flex-wrap items-center gap-4 text-sm text-slate-600">
        <div class="inline-flex items-center gap-2">
          <mat-icon class="text-slate-500">inventory_2</mat-icon>
          <span>Total de referencias</span>
          <span class="font-semibold">{{ filtered().length }}</span>
        </div>
        <div class="inline-flex items-center gap-2">
          <mat-icon class="text-slate-500">payments</mat-icon>
          <span>Costo total de inventario</span>
          <span class="font-semibold">Q {{ totalCost() | number:'1.0-0' }}</span>
        </div>
      </div>
    </div>

    <!-- Acciones derechas -->
    <div class="flex flex-wrap items-center gap-3">
      <button mat-stroked-button class="rounded-full px-4" (click)="openCategories()">
        <mat-icon class="mr-2">sell</mat-icon> Categorías
      </button>

      <button mat-stroked-button class="rounded-full px-4" [matMenuTriggerFor]="createMenu">
        Crear productos <mat-icon class="ml-1">expand_more</mat-icon>
      </button>
      <mat-menu #createMenu="matMenu">
        <button mat-menu-item (click)="createProduct()">
          <mat-icon>add_circle</mat-icon>
          <span>Crear productos manualmente</span>
        </button>
        <button mat-menu-item disabled>
          <mat-icon>description</mat-icon>
          <span>Subir productos desde Excel</span>
        </button>
      </mat-menu>
    </div>
  </div>

  <!-- MÉTRICAS / FILTROS RÁPIDOS (FIJOS) -->
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3">
    <!-- TODOS -->
    <button
      class="rounded-2xl border transition text-left p-4 hover:shadow-sm"
      [class.border-indigo-300]="selectedStockFilter() === 'all'"
      [class.bg-indigo-50]="selectedStockFilter() === 'all'"
      (click)="selectStockFilter('all')">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-xs uppercase tracking-wide text-slate-500">Todos</div>
          <div class="text-2xl font-semibold text-slate-800">{{ data().length }}</div>
        </div>
        <mat-icon class="text-slate-500">grid_view</mat-icon>
      </div>
    </button>

    <!-- BAJA (1–2) -->
    <button
      class="rounded-2xl border transition text-left p-4 hover:shadow-sm"
      [class.border-amber-300]="selectedStockFilter() === 'low'"
      [class.bg-amber-50]="selectedStockFilter() === 'low'"
      (click)="selectStockFilter('low')">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-xs uppercase tracking-wide text-slate-500">Baja existencia (1–2)</div>
          <div class="text-2xl font-semibold text-amber-700">{{ lowStockCount() }}</div>
        </div>
        <mat-icon class="text-amber-600">warning</mat-icon>
      </div>
    </button>

    <!-- AGOTADOS (0) -->
    <button
      class="rounded-2xl border transition text-left p-4 hover:shadow-sm"
      [class.border-rose-300]="selectedStockFilter() === 'out'"
      [class.bg-rose-50]="selectedStockFilter() === 'out'"
      (click)="selectStockFilter('out')">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-xs uppercase tracking-wide text-slate-500">Agotados (0)</div>
          <div class="text-2xl font-semibold text-rose-700">{{ outOfStockCount() }}</div>
        </div>
        <mat-icon class="text-rose-600">do_not_disturb</mat-icon>
      </div>
    </button>
  </div>

  <!-- FILTROS (FIJOS) -->
  <div class="flex flex-wrap items-center gap-3 py-3">
    <mat-form-field appearance="outline" class="flex-1 min-w-[260px]">
      <mat-label>Buscar por nombre</mat-label>
      <input matInput [formControl]="form.controls.search" (input)="applySearch()">
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <button mat-stroked-button class="rounded-xl px-4">
      <mat-icon class="mr-2">qr_code_scanner</mat-icon> Catálogo virtual
    </button>

    <button mat-flat-button color="primary" class="rounded-xl px-4">
      <mat-icon class="mr-2">shopping_basket</mat-icon> Registrar compras
    </button>

    <button mat-stroked-button class="rounded-xl px-4">
      <mat-icon class="mr-2">download</mat-icon> Descargar
    </button>

    <button mat-stroked-button class="rounded-xl px-4 ml-auto" (click)="clearAllFilters()">
      <mat-icon class="mr-2">filter_alt_off</mat-icon> Limpiar filtros
    </button>
  </div>

  <!-- CHIPS CATEGORÍAS (FIJOS) -->
  <div class="flex flex-wrap items-center gap-2 mb-3">
    <button mat-stroked-button class="rounded-full px-3 py-1"
            [color]="selectedCategory() === null ? 'primary' : undefined"
            (click)="selectCategory(null)">Ver todos</button>

    <button mat-stroked-button class="rounded-full px-3 py-1"
            *ngFor="let c of categories()"
            [color]="selectedCategory() === c ? 'primary' : undefined"
            (click)="selectCategory(c)">{{ c }}</button>
  </div>

  <!-- SOLO LA TABLA ES SCROLLABLE -->
  <div class="flex-1 min-h-0">
    <div class="bg-white rounded-2xl border border-gray-200 h-full overflow-auto bg-yellow-50">
      <!-- Mensaje cuando no hay productos -->
      <div *ngIf="filtered().length === 0" class="p-6 text-center text-sm text-slate-500">
        No hay productos para mostrar.
      </div>

      <table *ngIf="filtered().length > 0"
             mat-table
             [dataSource]="paged()"
             class="w-full min-w-[700px]">

        <!-- Col: Producto -->
        <ng-container matColumnDef="product">
          <th mat-header-cell *matHeaderCellDef class="sticky-th px-6 py-4 text-left text-slate-600">Producto</th>
          <td mat-cell *matCellDef="let p" class="px-6 py-4">
            <div class="flex items-center gap-3">
              <img [src]="p.image || ''"
                   class="w-10 h-10 rounded-md bg-gray-100 object-cover"
                   alt="" />
              <a class="font-medium text-slate-800 underline">{{ p.name }}</a>
            </div>
          </td>
        </ng-container>

        <!-- Col: Precio -->
        <ng-container matColumnDef="price">
          <th mat-header-cell *matHeaderCellDef class="sticky-th px-3 py-4 text-left text-slate-600">Precio</th>
          <td mat-cell *matCellDef="let p" class="px-3 py-3">
            <mat-form-field appearance="outline" class="w-36">
              <input matInput type="number" min="0"
                     [value]="p.price"
                     (change)="setPrice(p, $any($event.target).value)" />
              <span matPrefix class="mr-1">Q</span>
            </mat-form-field>
          </td>
        </ng-container>

        <!-- Col: Costo -->
        <ng-container matColumnDef="cost">
          <th mat-header-cell *matHeaderCellDef class="sticky-th px-3 py-4 text-left text-slate-600">Costo</th>
          <td mat-cell *matCellDef="let p" class="px-3 py-3">
            <mat-form-field appearance="outline" class="w-36">
              <input matInput type="number" min="0"
                     [value]="p.cost"
                     (change)="setCost(p, $any($event.target).value)" />
              <span matPrefix class="mr-1">Q</span>
            </mat-form-field>
          </td>
        </ng-container>

        <!-- Col: Stock -->
        <ng-container matColumnDef="stock">
          <th mat-header-cell *matHeaderCellDef class="sticky-th px-3 py-4 text-left text-slate-600">Cantidad disponible</th>
          <td mat-cell *matCellDef="let p" class="px-3 py-3">
            <div class="flex items-center gap-2">
              <mat-form-field appearance="outline" class="w-28">
                <input matInput type="number" min="0"
                       [value]="p.stock"
                       (change)="setStock(p, $any($event.target).value)" />
              </mat-form-field>
              <span class="inline-block text-xs px-2 py-1 rounded-full"
                    [class.bg-amber-100]="p.stock === 1 || p.stock === 2"
                    [class.text-amber-700]="p.stock === 1 || p.stock === 2"
                    [class.bg-rose-100]="p.stock === 0"
                    [class.text-rose-700]="p.stock === 0"
                    [class.bg-emerald-100]="p.stock > 2"
                    [class.text-emerald-700]="p.stock > 2">
                <ng-container [ngSwitch]="true">
                  <span *ngSwitchCase="p.stock === 0">Agotado</span>
                  <span *ngSwitchCase="p.stock === 1 || p.stock === 2">Bajo</span>
                  <span *ngSwitchDefault>OK</span>
                </ng-container>
              </span>
            </div>
          </td>
        </ng-container>

        <!-- Col: Ganancia -->
        <ng-container matColumnDef="profit">
          <th mat-header-cell *matHeaderCellDef class="sticky-th px-3 py-4 text-left text-slate-600">Ganancia</th>
          <td mat-cell *matCellDef="let p" class="px-3 py-3">
            <div class="flex items-center gap-2">
              <span>Q {{ profitAmount(p) | number:'1.2-2' }}</span>
              <span class="inline-block text-xs px-2 py-1 rounded-full"
                    [class.bg-emerald-100]="profitPercent(p) >= 0"
                    [class.text-emerald-700]="profitPercent(p) >= 0"
                    [class.bg-rose-100]="profitPercent(p) < 0"
                    [class.text-rose-700]="profitPercent(p) < 0">
                {{ profitPercent(p) | number:'1.0-0' }}%
              </span>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="cols"></tr>
        <tr mat-row *matRowDef="let row; columns: cols;" class="hover:bg-slate-50"></tr>
      </table>
            <!-- PAGINADOR -->
      <div *ngIf="filtered().length > 0" class="px-4 pb-4 pt-2">
        <div class="flex items-center justify-between text-xs md:text-sm text-slate-600 mb-2">
          <div>
            Mostrando
            <span class="font-semibold">{{ pageStart() }}</span>
            –
            <span class="font-semibold">{{ pageEnd() }}</span>
            de
            <span class="font-semibold">{{ filtered().length }}</span>
            productos
          </div>
        </div>

        <mat-paginator
          [length]="filtered().length"
          [pageIndex]="pageIndex()"
          [pageSize]="pageSize()"
          [pageSizeOptions]="[5, 10, 20, 50]"
          (page)="onPageChange($event)"
          showFirstLastButtons>
        </mat-paginator>
      </div>

    </div>
  </div>

  <!-- PANEL LATERAL -->
  <ng-container *ngIf="drawerOpened">
    <div class="fixed inset-0 bg-black/30 z-40" (click)="drawerOpened=false"></div>
    <div class="fixed inset-y-0 right-0 w-[420px] max-w-full bg-white z-50 shadow-xl">
      <div class="p-6">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-semibold text-slate-800">Categorías</h3>
          <button mat-icon-button (click)="drawerOpened=false"><mat-icon>close</mat-icon></button>
        </div>

        <div class="mt-6 space-y-3">
          <button mat-stroked-button color="primary" class="w-full rounded-xl h-14 justify-start">
            <mat-icon class="mr-3">add</mat-icon> Crear Nueva Categoría
          </button>

          <div class="rounded-xl border border-slate-200 divide-y">
            <button class="w-full text-left p-4 hover:bg-slate-50 flex items-center justify-between">
              <span><mat-icon class="mr-2">label</mat-icon> Bocinas</span>
              <mat-icon>chevron_right</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </div>
  </ng-container>
</section>
